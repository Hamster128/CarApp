<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="viewport" content = "user-scalable=no, viewport-fit=cover" />
        <meta http-equiv="Pragma" content="no-cache">
        
        <title>Cupra</title>
        <style>

          .button {
            font-size: 60px;
          }

          .symbol {
            font-size: 220px;
            border: 10px solid transparent;
            border-radius: 25px;
            padding: 20px;
          }

          .select {
            font-size: 50px;
          }

          .clicked {
            border: 10px solid #CCC;
          }
          .clicked_start {
            border: 10px solid #0A0;
          }
          .clicked_stop {
            border: 10px solid #C00;
          }

          .symbol_td {
            text-align:center;
            cursor:pointer;
          }

          .green {
            color: #0A0;
          }
          .white {
            color: #EEE;
          }
          .grey {
            color: #666;
          }
          .red {
            color: #C11;
          }
          .blue {
            color: #68F;
          }
          .yellow {
            color: #FD0;
          }

          .kw {
            font-size: 70px;
          }

          .td_limit_marker {
            text-align: right;
            font-size: 100px;
            cursor:pointer;
          }

          .slider {
            -webkit-appearance: none;
            background: transparent;
            height:40px;
          }

          .slider::-webkit-slider-thumb {
            -webkit-appearance: none; /* Override default look */
            appearance: none;
            width: 76px; /* Set a specific slider handle width */
            height: 76px; /* Slider handle height */
            cursor: pointer; /* Cursor on hover */
            background-image: url('/static/slider.png');
            background-color: transparent;
          }

          .setslider {
            height: 58px;
            -webkit-appearance: none;
            margin: 10px 0;
            width: 100%;
            background: #000;
          }
          
          .setslider::-webkit-slider-runnable-track {
            width: 100%;
            height: 25px;
            cursor: pointer;
            animate: 0.2s;
            box-shadow: 1px 1px 1px #000000;
            background: #2081C9;
            border-radius: 12px;
            border: 1px solid #000000;
          }

          .setslider::-webkit-slider-thumb {
            box-shadow: 1px 1px 1px #000000;
            border: 1px solid #000000;
            height: 70px;
            width: 70px;
            border-radius: 35px;
            background: #FFFFFF;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -22px;
          }

          input.switch {
            width: 60px;
            height: 60px;
            margin-right: 30px;
          }

          .switch_label {
            font-size: 50px;
            cursor: pointer;
          }

          .switch_td {
            padding-top:70px;
          }

          body {
            position: fixed;
            overflow: hidden;
            background: #000;
            background-image: url(static/back.jpg);
            background-size: 100%;
            margin:0px;
            font-family: Arial, Helvetica, sans-serif; 
            color:#AAA; 
            font-size:50px;
          }

          @media (orientation: landscape) {
            body {
              transform-origin: 0 0;
              transform:scale(0.5);
            }
          }
        </style>

    </head>
    <body>
      <script src="/static/socket.io.min.js"></script>
      <script src="/static/jquery-3.6.0.min.js"></script>
      <script src="/static/moment.min.js"></script>
      <script src="https://kit.fontawesome.com/e51bfceb96.js" crossorigin="anonymous"></script>

      <div style="position:absolute; width:100vw; height:100vh;">
        <div id="divDebug" style="font-size: 25px;"></div>

        <!-------------------------------------------------------------------------------------------------
        -- main page
        --------------------------------------------------------------------------------------------------->
        <div style="position:absolute; z-index: 10; width:100vw; height:100vh; top:0px;">
          <table style="width:100%; padding:30px;">
            <tr>
              <td></td>
              <td style="text-align: right;" onClick="clickSettings()"><i id="symSettings" class="fa-solid fa-gear symbol" style="font-size: 100px;"></i></td>
            </tr>
            <tr>
              <td colspan=2>
                <h1 id="title" style="text-align: center;" onClick="update();">&nbsp;</h1>
                <h2 id="problem" style="text-align: center;" onClick="update();">&nbsp;</h2>
                <br>
              </td>
            </tr>
            <tr>
              <td id="soc_limit_clr"><span id="soc_limit"></span><span id="soc_rlimit"></span>%&nbsp;</td>
              <td>
                <input type="range" min="0" max="100" step="10" value="50" class="slider" id="limit_slider" style="width:100%;" onInput="changingChargeLimit(this.value);" onChange="setChargeLimit(this.value);">
              </td>
            </tr>
            <tr>
              <td width="10px" onClick="socket.emit('dump');"><span id="soc" style="font-size:80px;"></span>%&nbsp;</td>
              <td><meter min=0 max=100 low="20" id="soc_meter" value=80 style="width:100%; padding-left:36px; padding-right:36px; height:80px;"></meter></td>
            </tr>
            <tr style="height:57px;">
              <td></td>
              <td style="text-align:center;"><span id="soc_time"></span></td>
            </tr>
          </table>
          <br>
          <br>
          <table style="width:100%">
            <tr>
              <td class="symbol_td" onClick="clickCharging()"><i id="symCharging" class="fa-solid fa-plug-circle-xmark symbol"></i></td>
              <td class="symbol_td" onClick="clickClimate()"><i id="symClimate" class="fa-solid fa-fan symbol"></i></td>
            </tr>
            <tr style="height:100px">
              <td id="txtCharging" class="symbol_td"></td>
              <td class="symbol_td"><span id="txtClimate"></span></td>
            </tr>
            <tr><td style="height: 200px;"></td></tr>
            <tr>
              <td></td>
              <td class="symbol_td" onClick="clickPosition()"><i id="symPosition" class="fa-solid fa-globe" style="font-size: 110px;"></i></td>
            </tr>
          </table>
        </div>

        <!-------------------------------------------------------------------------------------------------
        -- settings page
        --------------------------------------------------------------------------------------------------->
        <div id="divSettings" style="visibility:hidden; position:absolute; z-index:20; top:0px; width:100vw; height:100vh; background-color: #000;">
          <table style="width:100%; padding:50px;">
            <tr>
              <td style="text-align:right; font-size:100px;" onClick="closeSettings();"><i class="fa-regular fa-circle-xmark"></i></td>
            </tr>
            <tr><td style="height: 100px;"></td></tr>
            <tr>
              <td>
                Stop charging remote at:&nbsp; <span id="soc_applimit"></span><br>
                <input type="range" min="10" max="100" step="5" value="50" class="setslider" id="applimit_slider" style="width:100%;" onInput="changingAppChargeLimit(this.value);" onChange="setAppChargeLimit(this.value);">
              </td>
            </tr>
            <tr><td style="height: 50px;"></td></tr>
            <tr>
              <td>
                Climatization:&nbsp; <span id="climatemp"></span><br>
                <input type="range" min="18" max="24" step="0.5" value="21" class="setslider" id="climatemp_slider" style="width:100%;" onInput="changingClimaTemp(this.value);" onChange="setClimaTemp(this.value);">
              </td>
            </tr>
            <tr><td style="height: 50px;"></td></tr>
            <tr>
              <td class="switch_td"><label id="limit_ac_label" class="switch_label">
                <input type="checkbox" class="switch" id="limit_ac" onChange="changedLimitAC(this.checked);">Limit AC charging</input>
              </label></td>
            </tr>
            <tr>
              <td class="switch_td">
                <label id="auto_unlock_label" class="switch_label">
                    <input type="checkbox" class="switch" id="auto_unlock" onChange="changedAutoUnlock(this.checked);">Auto unlock</input>
              </label></td>
            </tr>
            <tr>
              <td class="switch_td">
                <label id="schedule_charging_label" class="switch_label">
                  <input type="checkbox" class="switch" id="charging_at" onChange="changedChargingAt(this.checked);">Charging:&nbsp;
                </label>
                <select class="select" id="charging_at_h" onChange="changedChargingAtTime();">
                  <option value="0">00</option>
                  <option value="1">01</option>
                  <option value="2">02</option>
                  <option value="3">03</option>
                  <option value="4">04</option>
                  <option value="5">05</option>
                  <option value="6">06</option>
                  <option value="7">07</option>
                  <option value="8">08</option>
                  <option value="9">09</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14">14</option>
                  <option value="15">15</option>
                  <option value="16">16</option>
                  <option value="17">17</option>
                  <option value="18">18</option>
                  <option value="19">19</option>
                  <option value="20">20</option>
                  <option value="21">21</option>
                  <option value="22">22</option>
                  <option value="23">23</option>
                </select>
                :
                <select class="select" id="charging_at_m" onChange="changedChargingAtTime();">
                  <option value="0">00</option>
                  <option value="5">05</option>
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="20">20</option>
                  <option value="25">25</option>
                  <option value="30">30</option>
                  <option value="35">35</option>
                  <option value="40">40</option>
                  <option value="45">45</option>
                  <option value="50">50</option>
                  <option value="55">55</option>
                </select>
              </td>
            <tr>
              <td class="switch_td">
                <label id="climatisation_extend_label" class="switch_label">
                    <input type="checkbox" class="switch" id="climatisation_extend" onChange="changedClimatisationExtend(this.checked);">Keep climate on</input>
              </label></td>
            </tr>
            <tr>
              <td class="switch_td">
                <label id="schedule_climate_label" class="switch_label">
                  <input type="checkbox" class="switch" id="climatisation_at" onChange="changedClimatisationAt(this.checked);">A/C:&nbsp;
                </label>
                <select class="select" id="climatisation_at_h" onChange="changedClimatisationAtTime();">
                  <option value="0">00</option>
                  <option value="1">01</option>
                  <option value="2">02</option>
                  <option value="3">03</option>
                  <option value="4">04</option>
                  <option value="5">05</option>
                  <option value="6">06</option>
                  <option value="7">07</option>
                  <option value="8">08</option>
                  <option value="9">09</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14">14</option>
                  <option value="15">15</option>
                  <option value="16">16</option>
                  <option value="17">17</option>
                  <option value="18">18</option>
                  <option value="19">19</option>
                  <option value="20">20</option>
                  <option value="21">21</option>
                  <option value="22">22</option>
                  <option value="23">23</option>
                </select>
                :
                <select class="select" id="climatisation_at_m" onChange="changedClimatisationAtTime();">
                  <option value="0">00</option>
                  <option value="5">05</option>
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="20">20</option>
                  <option value="25">25</option>
                  <option value="30">30</option>
                  <option value="35">35</option>
                  <option value="40">40</option>
                  <option value="45">45</option>
                  <option value="50">50</option>
                  <option value="55">55</option>
                </select>
                &nbsp;&nbsp;&nbsp;
                <input type="checkbox" class="switch" id="climatisation_once" onChange="changedClimatisationDay();"/>1x
                <br>
                  <table class="climatisation_weekday" style="width:100%; margin-top:20px;">
                    <tr>
                      <td>Mo</td><td>Tu</td><td>We</td><td>Th</td><td>Fr</td><td>Sa</td><td>Su</td>
                    </tr>
                    <tr>
                      <td><input type="checkbox" class="switch" id="climatisation_mo" onChange="changedClimatisationDay();"/></td>
                      <td><input type="checkbox" class="switch" id="climatisation_tu" onChange="changedClimatisationDay();"/></td>
                      <td><input type="checkbox" class="switch" id="climatisation_we" onChange="changedClimatisationDay();"/></td>
                      <td><input type="checkbox" class="switch" id="climatisation_th" onChange="changedClimatisationDay();"/></td>
                      <td><input type="checkbox" class="switch" id="climatisation_fr" onChange="changedClimatisationDay();"/></td>
                      <td><input type="checkbox" class="switch" id="climatisation_sa" onChange="changedClimatisationDay();"/></td>
                      <td><input type="checkbox" class="switch" id="climatisation_su" onChange="changedClimatisationDay();"/></td>
                    </tr>
                  </table>
              </td>
            </tr>
          </table>
        </div>
      </div>

      <script>
          var socket = io('http://'+location.host);
          var socTime;

          let Config = {
            chargeLimit: 100
          };

          let actData, temp;

          // -----------------------------------------------------------------------------------------------
          window.addEventListener("error", function (e) {
            log(e.error.message);
            log(e.error.stack);
            return false;
          });
                    
          // -----------------------------------------------------------------------------------------------
          window.addEventListener('unhandledrejection', function (e) {
            log(e.reason.message);
            log(e.reason.stack);
          });

          // -----------------------------------------------------------------------------------------------
          function log(txt) {
            console.log(txt);
            $('#divDebug').append('<p>' + txt +'</p>');
            socket.emit('log', txt);
          }

          // -----------------------------------------------------------------------------------------------
          // currently not working
          function clickSettings() {
            $('#divSettings').css("visibility", "visible");
          }

          // -----------------------------------------------------------------------------------------------
          function closeSettings() {
            $('#divSettings').css("visibility", "hidden");
          }

          // -----------------------------------------------------------------------------------------------
          function clickCharging() {
            socket.emit('log', 'clickCharging');

            if($('#symCharging').hasClass('clicked_stop')) {
              socket.emit('command', {action: 'charging', state: 'start'});
            } else if($('#symCharging').hasClass('clicked_start')) {
              socket.emit('command', {action: 'charging', state: 'stop'});
            } else {

              if($('#symCharging').hasClass('white')) {

                $('#symCharging').addClass('clicked');
                socket.emit('command', {action: 'charging', state: 'start'});

              } else if($('#symCharging').hasClass('green')) {

                $('#symCharging').addClass('clicked');
                socket.emit('command', {action: 'charging', state: 'stop'});
              }
            }
          }

          // -----------------------------------------------------------------------------------------------
          function clickClimate() {
            socket.emit('log', 'clickClimate');

            if(       $('#symClimate').hasClass('clicked_stop')) {
              socket.emit('command', {action: 'climatisation', state: 'start'});
            } else if($('#symClimate').hasClass('clicked_start')) {
              socket.emit('command', {action: 'climatisation', state: 'stop'});
            } else {

              if($('#symClimate').hasClass('grey')) {

                $('#symClimate').addClass('clicked');

                sendClimateSettings();
                socket.emit('command', {action: 'climatisation', state: 'start'});

              } else {
                
                $('#symClimate').addClass('clicked');
                socket.emit('command', {action: 'climatisation', state: 'stop'});
              }
            }
          }

          // -----------------------------------------------------------------------------------------------
          function sendClimateSettings() {

            let temp = parseFloat($('#climatemp_slider').prop('value'));
            temp += 273.15;  // C -> K
            socket.emit('command', {action: 'climatisation', state: 'settings', body: {"targetTemperature_K": temp}});
          }

          // -----------------------------------------------------------------------------------------------
          function update() {
            $('#problem').html('updateing...');
            socket.emit('update');
          }

          // -----------------------------------------------------------------------------------------------
          function changingChargeLimit(charge_limit) {

            if(charge_limit < 50) {
              charge_limit = 50;
            }

            displayChargeLimit(charge_limit);
          }

          // -----------------------------------------------------------------------------------------------
          function setChargeLimit(charge_limit) {

            let chargeLimit = parseInt($('#soc_limit').html());
            $('#limit_slider').prop('value', chargeLimit);

            sendChargingSettings(chargeLimit);
          }

          // -----------------------------------------------------------------------------------------------
          function displayChargeLimit(charge_limit, setSlider) {

            if(setSlider) {
              $('#limit_slider').prop('value', charge_limit);
            }

            $('#soc_limit').html(charge_limit);

            let app_limit = parseInt($('#applimit_slider').prop('value'));

            if(app_limit < charge_limit) {
              $('#soc_limit_clr').addClass('red');
              $('#soc_rlimit').html(app_limit);
              $('#soc_limit').css('display', 'none');
            } else {
              $('#soc_limit_clr').removeClass('red');
              $('#soc_rlimit').html('');
              $('#soc_limit').css('display', '');
            }
          }

          // -----------------------------------------------------------------------------------------------
          function changedLimitAC(checked) {
            sendChargingSettings();
          }

          // -----------------------------------------------------------------------------------------------
          function changingAppChargeLimit(charge_imit) {
            $('#soc_applimit').html(charge_imit+"%");
          }

          // -----------------------------------------------------------------------------------------------
          function setAppChargeLimit(charge_imit) {
            Config.chargeLimit = charge_imit;
            socket.emit('set_config', Config);
          }

          // -----------------------------------------------------------------------------------------------
          function changedChargingAt(checked) {
            Config.chargingAt = checked;
            socket.emit('set_config', Config);
          }

          // -----------------------------------------------------------------------------------------------
          function changedChargingAtTime() {
            Config.chargingAtH = parseInt($('#charging_at_h').val());
            Config.chargingAtM = parseInt($('#charging_at_m').val());
            socket.emit('set_config', Config);
          }
          
          
          // -----------------------------------------------------------------------------------------------
          function changedClimatisationAt(checked) {
            Config.climatisationAt = checked;
            socket.emit('set_config', Config);
            updateClimatisationText();
          }

          // -----------------------------------------------------------------------------------------------
          function changedClimatisationAtTime() {
            Config.climatisationAtH = parseInt($('#climatisation_at_h').val());
            Config.climatisationAtM = parseInt($('#climatisation_at_m').val());
            socket.emit('set_config', Config);
          }

          // -----------------------------------------------------------------------------------------------
          function changedClimatisationDay() {
            Config.climatisationOnce = $('#climatisation_once').prop('checked');
            Config.climatisationtMo  = $('#climatisation_mo').prop('checked');
            Config.climatisationtTu  = $('#climatisation_tu').prop('checked');
            Config.climatisationtWe  = $('#climatisation_we').prop('checked');
            Config.climatisationtTh  = $('#climatisation_th').prop('checked');
            Config.climatisationtFr  = $('#climatisation_fr').prop('checked');
            Config.climatisationtSa  = $('#climatisation_sa').prop('checked');
            Config.climatisationtSu  = $('#climatisation_su').prop('checked');
            setClimatisationDayVisibillity();
            socket.emit('set_config', Config);
          }

          // -----------------------------------------------------------------------------------------------
          function setClimatisationDayVisibillity() {

            let val = '';

            if(Config.climatisationOnce) {
              val = 'none';
            }

            $('.climatisation_weekday').css('display', val);
          }

          // -----------------------------------------------------------------------------------------------
          function changingClimaTemp(temp) {
            $('#climatemp').html(temp+"°C");
          }

          // -----------------------------------------------------------------------------------------------
          function setClimaTemp(temp) {
            sendClimateSettings();
          }

          // -----------------------------------------------------------------------------------------------
          function changedAutoUnlock(checked) {
            sendChargingSettings();
          }

          // -----------------------------------------------------------------------------------------------
          function changedClimatisationExtend(checked) {
            Config.climatisationExtend = checked;
            socket.emit('set_config', Config);
            updateClimatisationText();
          }

          // -----------------------------------------------------------------------------------------------
          function sendChargingSettings() {

            let body = {
              "autoUnlockPlugWhenCharged": $('#auto_unlock').prop('checked') ? "permanent" : "off",
              "maxChargeCurrentAC": $('#limit_ac').prop('checked') ? "reduced" : "maximum",
              "targetSoc_pct": $('#limit_slider').prop('value')
            };

            socket.emit('command', {action: 'charging', state: 'settings', body: body});
          }

          // -----------------------------------------------------------------------------------------------
          socket.io.on('close', function() {
            $('#problem').html('disconnected');
          });

          // -----------------------------------------------------------------------------------------------
          socket.io.on('reconnect', function() {
            $('#problem').html('&nbsp;');
          });

          // -----------------------------------------------------------------------------------------------
          socket.on('problem', function (problem) {
            $('#problem').html(`<span style="color:#F00;">${problem}</span>`);
          }); 

          // -----------------------------------------------------------------------------------------------
          socket.on('data', function (data) {

            $('#title').html(data.vehicleNickname);
            
            if(data.newData) {
              $('#problem').html('&nbsp;');
            }

            actData = data;

            $('#soc').html(data.charging.status.battery.currentSOC_pct);
            $('#soc_meter').prop('value', data.charging.status.battery.currentSOC_pct);

            socTime = moment(data.charging.status.battery.carCapturedTimestamp);
            updateSOCtime();

            Config = data.Config;

            // ---------------------------------------- CHARGING LIMIT ----------------------------------------
            $('#soc_applimit').html(data.Config.chargeLimit+"%");
            $('#applimit_slider').val(data.Config.chargeLimit);

            $('#soc_limit_clr').removeClass('green');
            $('#limit_ac_label').removeClass('green');
            $('#auto_unlock_label').removeClass('green');

            if(data.activeCommands['charging_settings']) {

              if(data.activeCommands['charging_settings'].body.targetSoc_pct != data.status.services.charging.targetPct) {
                $('#soc_limit_clr').addClass('green');
              }

              displayChargeLimit(data.activeCommands['charging_settings'].body.targetSoc_pct, true);


              if(data.activeCommands['charging_settings'].body.maxChargeCurrentAC != data.charging_settings.settings.maxChargeCurrentAC) {
                $('#limit_ac_label').addClass('green');
              }

              $('#limit_ac').prop('checked', data.activeCommands['charging_settings'].body.maxChargeCurrentAC == "reduced");  // maximum / reduced


              if(data.activeCommands['charging_settings'].body.autoUnlockPlugWhenCharged != data.charging_settings.settings.autoUnlockPlugWhenCharged) {
                $('#auto_unlock_label').addClass('green');
              }

              $('#auto_unlock').prop('checked', data.activeCommands['charging_settings'].body.autoUnlockPlugWhenCharged == "permanent");  // permanent / off

            } else {
              displayChargeLimit(data.status.services.charging.targetPct, true);
              $('#limit_ac').prop('checked', data.charging_settings.settings.maxChargeCurrentAC == "reduced");  // maximum / reduced
              $('#auto_unlock').prop('checked', data.charging_settings.settings.autoUnlockPlugWhenCharged == "permanent");  // permanent / off
            }


            // ---------------------------------------- CHARGING SYMBOL ----------------------------------------
            $('#symCharging').removeClass(['fa-plug-circle-check', 'fa-plug-circle-xmark', 'fa-plug-circle-minus', 'fa-circle-question', 'white', 'grey', 'red', 'yellow']);

            if(data.charging.status.charging.chargePower_kW) {

              $('#symCharging').addClass(['fa-plug-circle-bolt', 'green']);

            } else if(data.charging.status.plug.plugConnectionState == 'connected') {

              if(data.charging.status.plug.externalPower == 'unavailable') {
                $('#symCharging').addClass(['fa-plug-circle-xmark', 'red']);
              } else {
                if(data.charging.status.plug.plugLockState == 'locked') {
                  $('#symCharging').addClass(['fa-plug-circle-minus', 'white']);
                } else {
                  $('#symCharging').addClass(['fa-plug-circle-check', 'white']);
                }
              }
            } else if(data.charging.status.plug.plugConnectionState == 'unknown') {
              $('#symCharging').addClass(['fa-circle-question', 'yellow']);
            } else {
              $('#symCharging').addClass(['fa-plug-circle-xmark', 'grey']);
            }

            $('#symCharging').removeClass(['clicked', 'clicked_start', 'clicked_stop']);

            if(data.activeCommands['charging']) {
              if(       data.activeCommands['charging'].state == 'start' && !data.charging.status.charging.chargePower_kW) {
                $('#symCharging').addClass(['clicked_start']);
              } else if(data.activeCommands['charging'].state == 'stop'  &&  data.charging.status.charging.chargePower_kW) {
                $('#symCharging').addClass(['clicked_stop']);
              }
            }

            // ---------------------------------------- CHARGING TEXT ----------------------------------------
            if(data.charging.status.charging.chargePower_kW) {

              let finishedIn = moment.duration(data.status.services.charging.remainingTime, 'minutes');
              let socAge     = moment().diff(socTime);
              finishedIn.subtract(socAge, 'ms');
              let finishedAt = moment().add(finishedIn);

              $('#txtCharging').html('<span class="kw">'+data.charging.status.charging.chargePower_kW + '&nbsp;kW</span><br>' + 
                                     moment.utc(finishedIn.asMilliseconds()).format('HH:mm') + '&nbsp;&gt;&nbsp;' + 
                                     data.status.services.charging.targetPct + '%&nbsp;' + 
                                     finishedAt.format('HH:mm'));
            } else {

              let txt = '';
              if(Config.chargingAt) {
                txt = '<i class="fa-regular fa-clock"></i>';
              }

              $('#txtCharging').html(txt);

            }

            // ---------------------------------------- CLIMATISATION SYMBOL ----------------------------------------
            $('#symClimate').removeClass(['fa-circle-question', 'clicked', 'grey', 'green', 'red', 'blue', 'white', 'yellow']).addClass('fa-fan');

            if(       data.climatisation.data.climatisationStatus.climatisationState == 'heating') {
              $('#symClimate').addClass('red');
            } else if(data.climatisation.data.climatisationStatus.climatisationState == 'cooling') {
              $('#symClimate').addClass('blue');
            } else if(data.climatisation.data.climatisationStatus.climatisationState == 'ventilation') {
              $('#symClimate').addClass('white');
            } else if(data.climatisation.data.climatisationStatus.climatisationState == 'off') {
              $('#symClimate').addClass('grey');
            } else if(data.climatisation.data.climatisationStatus.climatisationState == 'unknown') {
              $('#symClimate').removeClass('fa-fan').addClass(['fa-circle-question', 'yellow']);
            } else {
              $('#symClimate').addClass('yellow');
            }

            $('#symClimate').removeClass(['clicked', 'clicked_start', 'clicked_stop']);

            if(data.activeCommands['climatisation']) {
              if(       data.activeCommands['climatisation'].state == 'start' && 
                        data.climatisation.data.climatisationStatus.climatisationState == 'off') {
                $('#symClimate').addClass('clicked_start');
              } else if(data.activeCommands['climatisation'].state == 'stop' && 
                        data.climatisation.data.climatisationStatus.climatisationState != 'off') {
                $('#symClimate').addClass('clicked_stop');
              }
            }

            // ---------------------------------------- CLIMATISATION SETTINGS-------------------------------------
            $('#climatemp').removeClass('green');

            if(data.activeCommands['climatisation_settings']) {

              if(data.activeCommands['climatisation_settings'].body.targetTemperature_K != data.climatisation_settings.settings.targetTemperature_K) {
                $('#climatemp').addClass('green');
              }

              temp = data.activeCommands['climatisation_settings'].body.targetTemperature_K - 273.15;  // K -> C

            } else {
              temp = data.climatisation_settings.settings.targetTemperature_K - 273.15;  // K -> C
            }

            $('#charging_at').prop('checked', data.Config.chargingAt);
            $('#charging_at_h').val(data.Config.chargingAtH);
            $('#charging_at_m').val(data.Config.chargingAtM);

            $('#climatemp').html(temp+"°C");
            $('#climatemp_slider').prop('value', temp);

            $('#climatisation_at').prop('checked', data.Config.climatisationAt);
            $('#climatisation_at_h').val(data.Config.climatisationAtH);
            $('#climatisation_at_m').val(data.Config.climatisationAtM);

            $('#climatisation_once').prop('checked', data.Config.climatisationOnce);
            $('#climatisation_mo'  ).prop('checked', data.Config.climatisationtMo);
            $('#climatisation_tu'  ).prop('checked', data.Config.climatisationtTu);
            $('#climatisation_we'  ).prop('checked', data.Config.climatisationtWe);
            $('#climatisation_th'  ).prop('checked', data.Config.climatisationtTh);
            $('#climatisation_fr'  ).prop('checked', data.Config.climatisationtFr);
            $('#climatisation_sa'  ).prop('checked', data.Config.climatisationtSa);
            $('#climatisation_su'  ).prop('checked', data.Config.climatisationtSu);
            setClimatisationDayVisibillity();

            $('#climatisation_extend'  ).prop('checked', data.Config.climatisationExtend);

            // ---------------------------------------- CLIMATISATION TEXT ----------------------------------------
            updateClimatisationText();

            // ---------------------------------------- POSITION --------------------------------------------------
            if(data.parkingposition.lat) {
              $('#symPosition').show();
            } else {
              $('#symPosition').hide();
            }

          });

          // -----------------------------------------------------------------------------------------------
          function clickPosition() {
            let wnd = window.open(`https://www.google.at/maps/place/${actData.parkingposition.lat},${actData.parkingposition.lon}`);
            wnd.close();
          }

          // -----------------------------------------------------------------------------------------------
          function updateClimatisationText() {

            if(actData.status.services.climatisation.active) {

              let stamp = moment.utc(actData.climatisation.data.climatisationStatus.carCapturedTimestamp);
              let age = moment().diff(stamp, 'minutes');

              let remainingMin   = Math.max(actData.climatisation.data.climatisationStatus.remainingClimatisationTime_min - age);
              let progressBarPct = actData.status.services.climatisation.progressBarPct;

              let txt = `${remainingMin} min`;

              if(Config.climatisationExtend) {
                txt += `&nbsp;&nbsp;<i class="fa-solid fa-rotate"></i>`;
              }

              $('#txtClimate').html(txt);
              
            } else {
              let txt = `${temp}°C`;

              if(Config.climatisationAt) {
                txt += '&nbsp;&nbsp;<i class="fa-regular fa-clock"></i>';
              }

              if(Config.climatisationExtend) {
                txt += `&nbsp;&nbsp;<i class="fa-solid fa-rotate"></i>`;
              }

              $('#txtClimate').html(txt);
            }

          }

          // -----------------------------------------------------------------------------------------------
          function updateSOCtime() {

            if(!socTime) {
              return;
            }

            $('#soc_time').html(socTime.fromNow());
          }

          setInterval(updateSOCtime, 5000);

        </script>
    </body>
</html>
